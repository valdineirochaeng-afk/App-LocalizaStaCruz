<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rotas Sta Cruz</title>

    <!-- CONEXÃO COM O MANIFEST (Faltava aqui) -->
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#007bff">
    <link rel="apple-touch-icon" href="./r-192x192.png">

    <style>
        body { font-family: sans-serif; padding: 20px; background: #f4f4f9; display: flex; justify-content: center; }
        .container { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); width: 100%; max-width: 400px; }
        h2 { color: #007bff; text-align: center; }
        label { font-weight: bold; display: block; margin-top: 15px; }
        select, button { width: 100%; padding: 12px; margin-top: 8px; border-radius: 8px; border: 1px solid #ddd; font-size: 16px; }
        button { background: #28a745; color: white; border: none; font-weight: bold; cursor: pointer; margin-top: 25px; }
        .status { font-size: 12px; text-align: center; margin-bottom: 10px; padding: 5px; border-radius: 5px; }
    </style>
</head>
<body>
    <div class="container">
        <h2>Localiza Sta Cruz</h2>
        <div id="status" class="status" style="background: #fff3cd;">Carregando dados...</div>

        <label>De (Origem):</label>
        <select id="origem"><option>Aguarde...</option></select>

        <label>Para (Destino):</label>
        <select id="destino"><option>Aguarde...</option></select>

        <button onclick="gerarRota()">ABRIR NO GOOGLE MAPS</button>
    </div>

    <script>
        const DATA_URL = './dadosLocais.json';
        let dados = [];

        // 1. REGISTRO DO SERVICE WORKER (Faltava aqui)
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.js')
                .then(() => console.log("Service Worker Registrado"))
                .catch(err => console.log("Erro SW:", err));
        }

        async function carregar() {
            const statusEl = document.getElementById('status');
            const selOri = document.getElementById('origem');
            const selDes = document.getElementById('destino');

            try {
                const res = await fetch(DATA_URL);
                if (!res.ok) throw new Error('Arquivo não encontrado');

                dados = await res.json();
                selOri.innerHTML = "";
                selDes.innerHTML = "";

                dados.forEach((item, i) => {
                    let opt = document.createElement('option');
                    opt.value = i;
                    opt.innerText = item.Nome || `Local ${i+1}`;
                    selOri.appendChild(opt.cloneNode(true));
                    selDes.appendChild(opt);
                });

                statusEl.innerText = "✅ Dados carregados com sucesso";
                statusEl.style.background = "#d4edda";
            } catch (e) {
                statusEl.innerText = "❌ Erro ao carregar JSON";
                statusEl.style.background = "#f8d7da";
            }
        }

        // Function to detect OS
        function getMobileOperatingSystem() {
            var userAgent = navigator.userAgent || navigator.vendor || window.opera;

            if (/android/i.test(userAgent)) {
                return "Android";
            }
            if (/iPad|iPhone|iPod/.test(userAgent) && !window.MSStream) {
                return "iOS";
            }
            return "unknown";
        }

        function gerarRota() {
            const valOri = document.getElementById('origem').value;
            const valDes = document.getElementById('destino').value;
            const c1 = dados[valOri];
            const c2 = dados[valDes];

            if (!c1 || !c2) return alert("Selecione os locais.");

            const os = getMobileOperatingSystem();
            let url = '';

            if (os === 'Android') {
                // Raw search URL for Google Maps on Android - might force local cache check
                url = `https://www.google.com/maps/search/?api=1&query=${c2.LATITUDE},${c2.LONGITUDE}`;
            } else if (os === 'iOS') {
                // Apple Maps URI for iOS to open a point
                url = `maps://?q=${c2.LATITUDE},${c2.LONGITUDE}(${encodeURIComponent(c2.Nome)})`;
                // Alternative for Google Maps on iOS for directions:
                // url = `comgooglemaps://?saddr=${c1.LATITUDE},${c1.LONGITUDE}&daddr=${c2.LATITUDE},${c2.LONGITUDE}&directionsmode=driving`;
            } else {
                // Fallback for desktop or unknown OS to use the web version for directions
                url = `https://www.google.com/maps/dir/${c1.LATITUDE},${c1.LONGITUDE}/${c2.LATITUDE},${c2.LONGITUDE}?travelmode=driving`;
            }
            
            window.open(url, '_blank');
        }

        window.onload = carregar;
    </script>
</body>
</html>
